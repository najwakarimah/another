<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Absen Kampus</title>
<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; }
.navbar-brand { font-weight: bold; }
.card { margin-bottom: 20px; }
#video { border: 1px solid #ccc; border-radius: 5px; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Portal Absen Kampus</a>
  </div>
</nav>

<div class="container mt-4" id="login-section">
  <div class="row justify-content-center">
    <div class="col-md-5">
      <div class="card p-4 shadow">
        <h3 class="card-title text-center mb-3">Login</h3>
        <input type="text" id="user-name-input" class="form-control mb-2" placeholder="Nama Lengkap">
        <select id="role" class="form-select mb-2">
          <option value="mahasiswa">Mahasiswa</option>
          <option value="dosen">Dosen</option>
        </select>
        <button class="btn btn-primary w-100" onclick="login()">Login</button>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4" id="dashboard" style="display:none;">
  <div class="row">
    <div class="col-md-12">
      <h4>Halo, <span id="user-name-display"></span> (<span id="role-display"></span>)</h4>
      <button class="btn btn-danger mb-3" onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="mahasiswa-dashboard" style="display:none;">
    <div class="row" id="matkul-list"></div>
  </div>

  <div id="dosen-dashboard" style="display:none;">
    <div class="card shadow p-3">
      <h5>Daftar Absen Mahasiswa</h5>
      <table class="table table-bordered mt-2">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Matkul</th>
            <th>Waktu</th>
            <th>Lokasi</th>
            <th>Foto</th>
          </tr>
        </thead>
        <tbody id="absen-table"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Absen -->
<div class="modal fade" id="absenModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Absen Matkul</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Masukkan QR Code hari ini:</p>
        <input type="text" id="qr-input" class="form-control mb-2" placeholder="QR Code">
        <button class="btn btn-success w-100 mb-2" onclick="cekQR()">Validasi QR</button>
        <div id="camera-section" style="display:none;">
          <video id="video" width="100%" autoplay></video>
          <button class="btn btn-primary w-100 mt-2" onclick="takeSnapshot()">Absen & Ambil Foto</button>
        </div>
        <div id="absen-success" style="display:none;">
          <p class="text-success">Absen berhasil!</p>
          <img id="snapshot-img" class="img-fluid mb-2">
          <p id="absen-waktu"></p>
          <p id="absen-lokasi"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentUser = {nama:"", role:""};
const QR_CODE_HARI_INI = "KAMPUS2025"; // ganti tiap pertemuan
const radiusValid = 0.05; // ~50 meter

function login(){
  const nama = document.getElementById('user-name-input').value.trim();
  const role = document.getElementById('role').value;
  if(!nama) return alert("Isi nama!");
  currentUser.nama = nama;
  currentUser.role = role;

  document.getElementById('login-section').style.display='none';
  document.getElementById('dashboard').style.display='block';
  document.getElementById('user-name-display').innerText = nama;
  document.getElementById('role-display').innerText = role;

  if(role==="mahasiswa") loadMatkul();
  else loadAbsenDosen();
}

function logout(){
  location.reload();
}

// Simulasi daftar matkul
const matkulData = ["Matematika", "Pemrograman", "Basis Data", "AI"];
function loadMatkul(){
  document.getElementById('mahasiswa-dashboard').style.display='block';
  const container = document.getElementById('matkul-list');
  container.innerHTML="";
  matkulData.forEach(m=>{
    const card = document.createElement('div');
    card.className="col-md-3";
    card.innerHTML=`
      <div class="card shadow p-3">
        <h5>${m}</h5>
        <button class="btn btn-primary w-100 mt-2" onclick="openAbsenModal('${m}')">Absen</button>
      </div>`;
    container.appendChild(card);
  });
}

// Modal Absen
let absenMatkul="";
let videoStream;
function openAbsenModal(matkul){
  absenMatkul = matkul;
  document.getElementById('qr-input').value="";
  document.getElementById('camera-section').style.display='none';
  document.getElementById('absen-success').style.display='none';
  new bootstrap.Modal(document.getElementById('absenModal')).show();
}

// QR Validation + Geo
function cekQR(){
  const qr = document.getElementById('qr-input').value.trim();
  if(qr !== QR_CODE_HARI_INI) return alert("QR Code salah!");
  // geolocation
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition((pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      // simulasi lokasi kelas: lat 0, lng 0
      if(Math.abs(lat-0)<radiusValid && Math.abs(lng-0)<radiusValid){
        document.getElementById('camera-section').style.display='block';
        startCamera();
      } else {
        alert("Anda berada di luar lokasi kelas!");
      }
    },()=>alert("Tidak bisa mendapatkan lokasi!"));
  } else alert("Geolocation tidak didukung browser!");
}

// Webcam
function startCamera(){
  navigator.mediaDevices.getUserMedia({video:true})
    .then(stream => { 
      videoStream = stream;
      document.getElementById('video').srcObject = stream;
    })
    .catch(err => alert("Error kamera: "+err));
}

function takeSnapshot(){
  const video = document.getElementById('video');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);
  const dataURL = canvas.toDataURL();

  document.getElementById('snapshot-img').src = dataURL;
  document.getElementById('absen-success').style.display='block';
  document.getElementById('absen-waktu').innerText = "Waktu: "+new Date().toLocaleString();
  document.getElementById('absen-lokasi').innerText = "Lokasi: 0,0";

  // stop camera
  videoStream.getTracks().forEach(track => track.stop());

  // simpan localStorage
  const absenList = JSON.parse(localStorage.getItem('absenList')||"[]");
  absenList.push({
    nama: currentUser.nama,
    role: currentUser.role,
    matkul: absenMatkul,
    waktu: new Date().toLocaleString(),
    lokasi: "0,0",
    foto: dataURL
  });
  localStorage.setItem('absenList', JSON.stringify(absenList));

  loadAbsenDosen();
}

// Load absen untuk dosen
function loadAbsenDosen(){
  if(currentUser.role!=="dosen") return;
  document.getElementById('dosen-dashboard').style.display='block';
  const table = document.getElementById('absen-table');
  const absenList = JSON.parse(localStorage.getItem('absenList')||"[]");
  table.innerHTML="";
  absenList.forEach(a=>{
    const row = document.createElement('tr');
    row.innerHTML=`
      <td>${a.nama}</td>
      <td>${a.matkul||"-"}</td>
      <td>${a.waktu}</td>
      <td>${a.lokasi}</td>
      <td><img src="${a.foto}" width="60"></td>
    `;
    table.appendChild(row);
  });
}
</script>

</body>
</html>
